name: Bot Automation Workflows

on:
  repository_dispatch:
    types: [new_url_received, refresh_token_received]

jobs:
  # --- JOB 1: store_refresh_token (Tugas: Menyimpan Refresh Token G-Drive Baru) ---
  store_refresh_token:
    if: github.event.action == 'refresh_token_received'
    runs-on: ubuntu-latest
    
    env:
      OWNER_ID: ${{ vars.OWNER_ID }}
      PAYLOAD_CHAT_ID: ${{ github.event.client_payload.sender_chat_id }}
      NEW_REFRESH_TOKEN: ${{ github.event.client_payload.refresh_token }}
      IS_OWNER_AUTH: ${{ github.event.client_payload.sender_chat_id == vars.OWNER_ID }}
      OWNER_SECRET_NAME: DRIVE_REFRESH_TOKEN_OWNER
      
    steps:
      - name: Checkout Repository (For gh CLI)
        uses: actions/checkout@v4
        
      - name: Calculate Target Variable Name
        id: secret_name_calc
        run: |
          TARGET_NAME=""
          if [ "${{ env.IS_OWNER_AUTH }}" == "true" ]; then
            TARGET_NAME="${{ env.OWNER_SECRET_NAME }}"
          else
            TARGET_NAME="DRIVE_REFRESH_TOKEN_USER_${{ env.PAYLOAD_CHAT_ID }}"
          fi
          echo "target_secret_name=$TARGET_NAME" >> $GITHUB_OUTPUT
        shell: bash
        
      - name: Update GitHub Variable (Store Refresh Token)
        run: |
          TARGET_SECRET_NAME="${{ steps.secret_name_calc.outputs.target_secret_name }}"
          echo "‚úÖ Storing Refresh Token to Variable: $TARGET_SECRET_NAME"
          # Perlu GH_PAT di Secrets GitHub
          gh variable set "$TARGET_SECRET_NAME" --body "${{ env.NEW_REFRESH_TOKEN }}" --repo ${{ github.repository }}
        env:
          GH_TOKEN: ${{ vars.GH_PAT }}
          
# -----------------------------------------------------------------------------

  # --- JOB 2: download-and-release (Tugas: Download dan Unggah Kondisional) ---
  download-and-release:
    if: github.event.action == 'new_url_received'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    # --- ENV Global di Tingkat Job ---
    env:
      PAYLOAD_URL: ${{ github.event.client_payload.url }}
      PAYLOAD_SENDER: ${{ github.event.client_payload.sender }}
      PAYLOAD_MODE: ${{ github.event.client_payload.mode }}
      
      # Variabel Global Telegram & Google Cloud
      BOT_TOKEN: ${{ vars.BOT_TOKEN }}
      API_ID: ${{ vars.API_ID }}
      API_HASH: ${{ vars.API_HASH }}
      GOOGLE_CLIENT_ID: ${{ vars.CLIENT_ID }}
      GOOGLE_CLIENT_SECRET: ${{ vars.CLIENT_SECRET }}
      OWNER_ID: ${{ vars.OWNER_ID }}
      
    steps:
      
      # --- BARU: Mengambil dan Menentukan Token Refresh ---
      - name: Get Drive Refresh Token
        id: refresh_token_setter
        if: env.PAYLOAD_MODE == 'gdrive'
        run: |
          TOKEN_NAME=""
          if [ "${{ env.PAYLOAD_SENDER }}" == "${{ env.OWNER_ID }}" ]; then
            TOKEN_NAME="DRIVE_REFRESH_TOKEN_OWNER"
          else
            TOKEN_NAME="DRIVE_REFRESH_TOKEN_USER_${{ env.PAYLOAD_SENDER }}"
          fi
          
          # Menggunakan GitHub CLI untuk mendapatkan nilai variabel dari repository vars
          # Catatan: Variabel diakses via vars[] atau secrets[] di GitHub Actions,
          # bukan dari variabel bash.
          TOKEN_VALUE="${{ vars[TOKEN_NAME] }}"
          echo "drive_token_value=$TOKEN_VALUE" >> $GITHUB_OUTPUT
        shell: bash
        
      - name: Checkout repository
        uses: actions/checkout@v4

# -----------------------------------------------------------------------------
# --- SETUP DEPENDENCIES ---
# -----------------------------------------------------------------------------
      
      - name: Grant permissions to APT cache
        run: |
          sudo chown -R $USER:$USER /var/cache/apt
          sudo chown -R $USER:$USER /var/lib/apt
          
      - name: Cache APT packages
        if: contains(env.PAYLOAD_URL, 'mega.nz')
        uses: actions/cache@v3
        with:
          path: |
            /var/cache/apt/archives
            /var/lib/apt/lists
          key: ${{ runner.os }}-apt-megatools
          restore-keys: |
            ${{ runner.os }}-apt-

      - name: Install megatools
        if: contains(env.PAYLOAD_URL, 'mega.nz')
        run: |
          chmod +x man-db-fast.sh && ./man-db-fast.sh
          sudo DEBIAN_FRONTEND=noninteractive apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install --no-install-recommends -y megatools
          
      - name: Create YouTube cookies file from secret
        env:
          YOUTUBE_COOKIES_SECRET: ${{ secrets.YOUTUBE_COOKIES }}
        if: env.YOUTUBE_COOKIES_SECRET != ''
        run: |
          echo "$YOUTUBE_COOKIES_SECRET" > cookies.txt

      - name: Cache venv
        id: cache-venv
        uses: actions/cache@v3
        with:
          path: .venv
          key: ${{ runner.os }}-venv-${{ hashFiles('requirements.txt') }}

      - name: dependency pip
        run: |
          python -m venv .venv
          source .venv/bin/activate
          echo ".venv/bin" >> $GITHUB_PATH
          if [ "${{ steps.cache-venv.outputs.cache-hit }}" != "true" ]; then
          pip install -r requirements.txt
          pip install pyrogram
          fi

# -----------------------------------------------------------------------------
# --- DOWNLOAD & UNGGAH ---
# -----------------------------------------------------------------------------

      - name: Run Downloader Script
        run: python main.py
        env:
          # Mengambil variabel global dari tingkat Job
          OWNER_ID: ${{ env.PAYLOAD_SENDER }}
          MEDIAFIRE_PAGE_URL: ${{ env.PAYLOAD_URL }}
          RCLONE_CONFIG: rclone.conf
          # Token dari output langkah di atas
          DRIVE_REFRESH_TOKEN: ${{ steps.refresh_token_setter.outputs.drive_token_value }}
          
      - name: Get Downloaded Filename
        id: get_filename
        run: |
          if [ ! -f "downloaded_filename.txt" ]; then
          echo "Error: downloaded_filename.txt not found. Exiting."
          exit 1
          fi
          FILE_NAME=$(cat downloaded_filename.txt | tr -d '\n')
          echo "file_name=$FILE_NAME" >> $GITHUB_OUTPUT
        shell: bash

      # --- CABANG UNGGAHAN KE TELEGRAM ---
      - name : Upload to Telegram (telegram_upload.py) üó£Ô∏è
        if: env.PAYLOAD_MODE == 'telegram'
        run: python telegram_upload.py
        shell: bash
        env:
          # Hanya perlu mengatur OWNER_ID (sudah dari env Job)
          OWNER_ID: ${{ env.PAYLOAD_SENDER }}
          
      # --- CABANG UNGGAHAN KE GOOGLE DRIVE ---
      - name : Upload to Google Drive (upload.py) ‚òÅÔ∏è
        if: env.PAYLOAD_MODE == 'gdrive'
        run: python upload.py
        shell: bash
        env:
          # Hanya perlu mengatur GH_TOKEN, FILENAME, dan Token dari output langkah
          GH_TOKEN: ${{ vars.GH_PAT }}
          DRIVE_REFRESH_TOKEN: ${{ steps.refresh_token_setter.outputs.drive_token_value }}
          FILENAME: ${{ steps.get_filename.outputs.file_name }}

      - name: Clean up apt cache
        run: |
          sudo rm -f /var/cache/apt/archives/lock
          sudo rm -f /var/lib/apt/lists/lock
          sudo rm -rf /var/cache/apt/archives/partial
          sudo rm -rf /var/lib/apt/lists/partial
